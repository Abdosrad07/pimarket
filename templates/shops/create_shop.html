{% extends 'base.html' %}

{% block title %}Créer ma Boutique - Pi Market{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="text-center mb-4">
            <i class="bi bi-shop-window" style="font-size: 4rem; color: var(--pi-purple);"></i>
            <h2 class="mt-3">Ouvrir votre boutique</h2>
            <p class="text-muted">Commencez à vendre vos produits sur Pi Market en quelques minutes.</p>
        </div>

        <div class="card">
            <div class="card-body p-4">
                <form id="createShopForm">
                    <div id="form-error" class="alert alert-danger d-none"></div>

                    <!-- CSRF Token, toujours important -->
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                    <div class="mb-3">
                        <label for="name" class="form-label">Nom de la boutique</label>
                        <input type="text" class="form-control form-control-lg" id="name" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="address_text" class="form-label">Adresse</label>
                        <input type="text" class="form-control" id="address_text" name="address_text" placeholder="Ex: 123 Rue Principale, Dakar" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Localisation sur la carte</label>
                        <button type="button" class="btn btn-outline-secondary w-100" id="getLocationBtn">
                            <i class="bi bi-crosshair"></i> Obtenir ma Position Actuelle
                        </button>
                        <input type="hidden" id="latitude" name="latitude" required>
                        <input type="hidden" id="longitude" name="longitude" required>
                        <small class="text-success d-none" id="locationStatus">
                            <i class="bi bi-check-circle"></i> Position obtenue
                        </small>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-pi btn-lg" id="submitBtn">
                            <i class="bi bi-plus-circle"></i> Créer la boutique
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('access_token');
    const user = JSON.parse(localStorage.getItem('user'));

    // 1. Vérifier si l'utilisateur est connecté côté client
    if (!token || !user) {
        window.location.href = "{% url 'login' %}?next=" + encodeURIComponent(window.location.pathname);
        return;
    }

    // 2. Gérer la soumission du formulaire via JavaScript
    const form = document.getElementById('createShopForm');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Création en cours...`;

        const errorDiv = document.getElementById('form-error');
        errorDiv.classList.add('d-none');

        const formData = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            address_text: document.getElementById('address_text').value,
            latitude: document.getElementById('latitude').value,
            longitude: document.getElementById('longitude').value,
        };

        try {
            const response = await fetch('/api/shops/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token,
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                // Redirection vers le tableau de bord vendeur
                window.location.href = "{% url 'seller_dashboard' %}";
            } else {
                const result = await response.json();
                let errorMessage = 'Une erreur est survenue. ';
                for (const key in result) {
                    errorMessage += `${key}: ${result[key].join(', ')} `;
                }
                errorDiv.textContent = errorMessage;
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            errorDiv.textContent = 'Erreur réseau. Veuillez réessayer.';
            errorDiv.classList.remove('d-none');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class="bi bi-plus-circle"></i> Créer la boutique`;
        }
    });
});

// 3. Logique de géolocalisation (inchangée)
document.getElementById('getLocationBtn').addEventListener('click', function() {
    const btn = this;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Obtention...';
    btn.disabled = true;

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
            document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
            document.getElementById('locationStatus').classList.remove('d-none');
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Position obtenue';
        }, function(error) {
            alert('Erreur de géolocalisation: ' + error.message);
            btn.innerHTML = '<i class="bi bi-crosshair"></i> Réessayer';
            btn.disabled = false;
        });
    } else {
        alert('La géolocalisation n\'est pas supportée par votre navigateur.');
    }
});
</script>
{% endblock %}