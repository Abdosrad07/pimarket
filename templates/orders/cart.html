{% extends 'base.html' %}

{% block title %}Votre Panier - Pi Market{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="bi bi-cart3"></i> Votre Panier</h2>
    </div>
</div>

<div class="row">
    <!-- Liste des articles -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <div id="cart-items-container">
                    <!-- Les articles du panier seront injectés ici par JavaScript -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Résumé de la commande -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header">
                <h5 class="mb-0">Résumé de la Commande</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Sous-total (Fiat)
                        <span id="subtotal-fiat">$0.00</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Sous-total (Pi)
                        <span id="subtotal-pi">0.00 π</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
                        Total
                        <div>
                            <span id="total-fiat" class="d-block text-end">$0.00</span>
                            <span id="total-pi" class="d-block text-end text-warning">0.00 π</span>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="card-footer d-grid">
                <a href="{% url 'checkout' %}" class="btn btn-pi btn-lg" id="checkout-btn">
                    <i class="bi bi-credit-card"></i> Procéder au Paiement
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cartItemsContainer = document.getElementById('cart-items-container');
    const subtotalFiatEl = document.getElementById('subtotal-fiat');
    const subtotalPiEl = document.getElementById('subtotal-pi');
    const totalFiatEl = document.getElementById('total-fiat');
    const totalPiEl = document.getElementById('total-pi');
    const checkoutBtn = document.getElementById('checkout-btn');

    function renderCart() {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-cart-x fs-1 text-muted"></i>
                    <h5 class="mt-3">Votre panier est vide</h5>
                    <p class="text-muted">Explorez nos produits pour commencer vos achats.</p>
                    <a href="{% url 'product_list' %}" class="btn btn-pi mt-3">
                        <i class="bi bi-shop"></i> Voir les produits
                    </a>
                </div>
            `;
            checkoutBtn.classList.add('disabled');
            updateTotals(cart);
            return;
        }

        let html = '';
        cart.forEach((item, index) => {
            html += `
                <div class="row mb-3 align-items-center">
                    <div class="col-2">
                        <img src="${item.image}" class="img-fluid rounded" alt="${item.title}">
                    </div>
                    <div class="col-4">
                        <h6 class="mb-0">${item.title}</h6>
                    </div>
                    <div class="col-3">
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${index}, -1)">-</button>
                            <input type="text" class="form-control text-center" value="${item.quantity}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${index}, 1)">+</button>
                        </div>
                    </div>
                    <div class="col-2 text-end">
                        <strong>$${(item.price_fiat * item.quantity).toFixed(2)}</strong>
                    </div>
                    <div class="col-1 text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                ${index < cart.length - 1 ? '<hr>' : ''}
            `;
        });

        cartItemsContainer.innerHTML = html;
        checkoutBtn.classList.remove('disabled');
        updateTotals(cart);
    }

    function updateTotals(cart) {
        const subtotalFiat = cart.reduce((sum, item) => sum + (item.price_fiat * item.quantity), 0);
        const subtotalPi = cart.reduce((sum, item) => sum + (item.price_pi * item.quantity), 0);

        subtotalFiatEl.textContent = `$${subtotalFiat.toFixed(2)}`;
        subtotalPiEl.textContent = `${subtotalPi.toFixed(2)} π`;
        totalFiatEl.textContent = `$${subtotalFiat.toFixed(2)}`;
        totalPiEl.textContent = `${subtotalPi.toFixed(2)} π`;
    }

    window.updateQuantity = function(index, change) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart[index]) {
            cart[index].quantity += change;
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
            updateCartCountInNav();
        }
    }

    window.removeItem = function(index) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
        updateCartCountInNav();
    }

    function updateCartCountInNav() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        const badge = document.getElementById('cart-count');
        if (badge) {
            badge.textContent = count;
        }
    }

    renderCart();
});
</script>
{% endblock %}